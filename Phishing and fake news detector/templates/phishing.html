<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Phishing Detector</title>

  <!-- Google font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <!-- Use Flask static URL so CSS loads from /static/css/ -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/phishing.css') }}">
  <style>
    .spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: rgba(255,255,255,0.9);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
      margin-left: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .detector-container{ max-width:560px; margin:24px auto; padding:20px; background:#fff; color:#111; border-radius:8px; text-align:center;}
    .input-wrapper { position: relative; width: 100%; }
    input[type="url"]{ width:100%; padding:12px 32px 12px 12px; margin:12px 0; font-size:16px; }
    .clear-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      font-size: 18px;
      color: #999;
      display: none;
    }
    .clear-btn:hover { color: #555; }
    button{ padding:10px 16px; font-size:16px; cursor:pointer; }
    #result{ margin-top:14px; font-weight:600; min-height:28px; }
  </style>
</head>
<body>

  <header>
    <div class="container">
      <h1>Phishing Detector</h1>
    </div>
  </header>

  <main>
    <section class="detector-section">
      <div class="detector-container">
        <h2>Check if a URL is Safe or Phishing</h2>

        <form id="phishForm" method="post" action="{{ url_for('phishing_page') }}">
          <div class="input-wrapper">
            <input type="url" id="urlInput" name="url" placeholder="Enter URL here (include https:// or example.com)" required aria-label="URL to check">
            <span class="clear-btn" id="clearBtn">&times;</span>
          </div>

          <div style="margin-top:10px;">
            <button id="checkBtn" type="button">Check URL</button>
            <button id="hiddenSubmit" type="submit" style="display:none">Submit</button>
          </div>
        </form>

        <p id="result" role="status" aria-live="polite"></p>

        <button class="home-btn" onclick="goHome()">Back to Home</button>
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 CyberGuard AI | Built for Security & Trust.</p>
  </footer>

  <script>
    const checkBtn = document.getElementById('checkBtn');
    const result = document.getElementById('result');
    const urlInput = document.getElementById('urlInput');
    const clearBtn = document.getElementById('clearBtn');
    const phishForm = document.getElementById('phishForm');

    // Show/hide clear button based on input
    urlInput.addEventListener('input', () => {
      clearBtn.style.display = urlInput.value ? 'block' : 'none';
    });

    // Clear input on clicking ×
    clearBtn.addEventListener('click', () => {
      urlInput.value = '';
      clearBtn.style.display = 'none';
      urlInput.focus();
    });

    function normalizeUrl(u) {
      try { return new URL(u).toString(); }
      catch { try { return new URL('https://' + u).toString(); } catch { return null; } }
    }

    function isSafeSuggestion(url) {
      try { const u = new URL(url); return (u.protocol==='http:'||u.protocol==='https:'); } 
      catch { return false; }
    }

    function showSpinner() {
      const s = document.createElement('span');
      s.className = 'spinner';
      s.id = 'loadingSpinner';
      checkBtn.parentNode.insertBefore(s, checkBtn.nextSibling);
    }
    function hideSpinner() {
      const s = document.getElementById('loadingSpinner'); if(s)s.remove();
    }

    checkBtn.addEventListener('click', async () => {
      const raw = urlInput.value.trim();
      if (!raw) { result.textContent="Please enter a URL!"; result.style.color="#f44336"; return; }

      const normalized = normalizeUrl(raw);
      if (!normalized) { result.textContent="Please enter a valid URL."; result.style.color="#f44336"; return; }

      checkBtn.disabled = true;
      showSpinner();
      const prevText = checkBtn.textContent;
      checkBtn.textContent = "Checking...";

      try {
        const resp = await fetch("{{ url_for('phishing_page') }}", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({url: normalized})
        });
        const data = await resp.json();

        if(!resp.ok){
          result.textContent = data.error || "Server error";
          result.style.color="#f44336";
        } else {
          const backendResult = (data.result || "").toString();
          if (backendResult.toLowerCase().includes("phish") || backendResult.toLowerCase().includes("suspicious")) {
            result.style.color="#f44336";
            result.textContent="⚠️ "+backendResult;
          } else {
            result.style.color="#4caf50";
            result.textContent="✅ "+backendResult;
          }
          if (data.suggestion && isSafeSuggestion(data.suggestion)) {
            const s = document.createElement('div');
            s.style.marginTop='8px';
            s.innerHTML=`<strong>Suggestion:</strong> <a href="${data.suggestion}" target="_blank" rel="noopener noreferrer">${data.suggestion}</a>`;
            result.appendChild(s);
          }
        }
      } catch(err){
        console.error(err);
        result.textContent = "Network error: "+err.message;
        result.style.color="#f44336";
      } finally {
        checkBtn.disabled=false;
        hideSpinner();
        checkBtn.textContent=prevText;
      }
    });

    urlInput.addEventListener('keydown', function(e){
      if(e.key==='Enter'){ e.preventDefault(); checkBtn.click(); }
    });

    phishForm.addEventListener('submit', function(e){ if(window.fetch)e.preventDefault(); });

    function goHome(){ window.location.href="{{ url_for('home') }}"; }
  </script>
</body>
</html>
